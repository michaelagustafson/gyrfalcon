---
title: "04_addhabitat"
author: "Michaela Gustafson"
date: "1/1/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Adding Habitat Data from ABoVE Dataset

In this code I will be importing GPS points for 2019 and 2021 prey surveys.

I will be adding land cover raster data from: https://daac.ornl.gov/ABOVE/guides/Annual_Landcover_ABoVE.html

1. I will group land cover types into more broad categories.
2. Create a separate layer for each land cover type.
3. Run a focal function for a 390m buffer to be able to extract the proportion of that habitat type within a 390(400m) buffer around each survey point


## LIBRARY
These are the packages used in this code:
```{r library}
library(terra)
library(sf)
library(sp)
library(here)
library(rgdal)
library(ggplot2)
library(tidyverse)
library(raster)
library(taRifx)
library(tidyr)
library(dplyr)
library(stringr)
```
## UPLOAD LAND COVER RASTERS
I will be selecting out the files that have the land cover for 2014. The four tiles called in below cover the study area.

```{r landcover}

test.tif.14 <- raster::raster(here("data/ABoVE_2014lyrs/ABoVE_LandCover_Bh04v01_2014.tif"))
plot(test.tif.14)

test.tif2.14 <- raster::raster(here("data/ABoVE_2014lyrs/ABoVE_LandCover_Bh04v02_2014.tif"))
plot(test.tif2.14)

test.tif3.14 <- raster::raster(here("data/ABoVE_2014lyrs/ABoVE_LandCover_Bh03v01_2014.tif"))
plot(test.tif3.14)

test.tif4.14 <- raster::raster(here("data/ABoVE_2014lyrs/ABoVE_LandCover_Bh03v02_2014.tif"))
plot(test.tif4.14)


r <- raster::merge(test.tif.14, test.tif2.14, test.tif3.14, test.tif4.14)


plot(r)
crs(r)

```

## Create separate raster layers for each habitat type

1. Add legend to raster data so we know what number corresponds to what habitat type
```{r lclegend}
aboveLC <- read.csv(here("data/ABoVE_LandClass_Labels.csv"))
str(aboveLC)
aboveLC$Code <- as.factor(aboveLC$Code)
print(aboveLC)
```

2. Separate out each habitat type

I will group land cover types as so:
Tundra = `Herbaceous`
Tussock = `Tussock Tundra`
Low_Shrub = `Low Shrub`
Bare_Ground = `Barren` + `Sparsely Vegetated`
Tall_Shrub = `Tall Shrub`
Open_Shrub = `Open Shrubs`
Forest = `Deciduous Forest` + `Evergreen Forest` + `Mixed Forest` + 'Woodland'
Wetland = `Fen` + `Shallows/littoral`

```{r separatelayers}

egforest <- (r == 1)
decforest <- (r == 2)
mixforest <- (r == 3)
woodland <- (r == 4)
lowshrub <- (r == 5)
tallshrub <- (r == 6)
openshrub <- (r == 7)
tundra <- (r == 8)
tussock <- (r == 9)
sparseveg <- (r == 10)
fen <- (r == 11)
bog <- (r == 12)
littoral <- (r == 13)
barren <- (r == 14)
water <- (r == 15)

```
3. Combine SpatRasters into a RasterStack
```{r restack}

lc_stack <- raster::stack(egforest, decforest, mixforest, woodland, lowshrub, tallshrub, openshrub, tundra, tussock, sparseveg, fen, bog, littoral, barren, water)

```
4. Crop? Don't really have a good site polygon that I could crop to...

lc_stack <- crop(lc_stack, siteC_ec)
lc_stack <- mask(lc_stack, siteC_ec)


5. Run focal function to get how much area is covered by each land cover type in the buffer size of 390m (13x13 30m cells)
```{r focal}
# run a for loop that will use the focal function to calculate the percentage of each habitat type within our 390m square buffer.

# first need to create empty lists that the data from the for loop will be stored in
lc_stack2 <- list()
lc_stack3 <- list()

# heres the loop
for(i in 1:length(lc_stack)){
  lc_stack2[[i]] <- raster::focal(lc_stack[[i]], w=matrix(1, nrow=13, ncol=13), fun=sum, na.rm=TRUE)
  lc_stack3[[i]] <- (lc_stack2[[i]]/169)
}

# restack the layers
lc_stack3 <- raster::stack(lc_stack3)
# now change the names of the columns to match what habitat type they actually are
names(lc_stack3) <- c("egforest", "decforest", "mixforest", "woodland", "lowshrub", "tallshrub", "openshrub", "tundra", "tussock", 'sparseveg', 'fen', 'bog', 'littoral', 'barren', 'water')


# test plot
plot(lc_stack3[[3]])


# save each layer as it own tif
setwd(here())
writeRaster(lc_stack3, filename=names(lc_stack3), bylayer=TRUE, format="GTiff", overwrite = TRUE)


```

## IN NEXT CODE: EXTRACT LAND COVER VALUES FOR EACH SURVEY POINT
